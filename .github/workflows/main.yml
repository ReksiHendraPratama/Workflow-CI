name: Kriteria 3 (Advance) - CI & Build Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-train-and-push:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash -l {0} 

    steps:
      # Langkah 1-3: Checkout, Python, Conda
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: 3.9
          activate-environment: none 
          auto-activate-base: false

      # Langkah 4: Install MLflow[docker], DagsHub, dan Joblib
      - name: Install MLflow[docker] dependencies in base
        run: |
          pip install "mlflow[docker]" dagshub joblib

      # Langkah 5: Login ke Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # Langkah 6: Setup Kredensial DagsHub
      - name: Set DagsHub Environment Variables
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: |
          echo "MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_USERNAME=${MLFLOW_TRACKING_USERNAME}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_PASSWORD=${MLFLOW_TRACKING_PASSWORD}" >> $GITHUB_ENV

      # Langkah 7: Buat Env Conda secara Manual
      - name: Create Conda Environment from conda.yaml
        run: |
          # Pastikan conda.yaml Anda berisi 'joblib'
          echo "  - joblib" >> MLProject/conda.yaml
          conda env create -f MLProject/conda.yaml

      # --- PERBAIKAN FINAL DI SINI ---
      
      # Langkah 8 (BARU): HANYA Jalankan Training
      - name: Run Training (Create 'model_local_output' folder)
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ env.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ env.MLFLOW_TRACKING_PASSWORD }}
        run: |
          # 1. Aktifkan environment yang baru dibuat
          conda activate mlops-k3-env
          
          # 2. Jalankan script python Anda (Training)
          echo "--- (Mulai Kriteria 3 Basic) Mulai Pelatihan Model ---"
          # (Script ini akan membuat folder 'model_local_output')
          python MLProject/modelling.py

      # Langkah 9 (BARU): HANYA Build Docker (TANPA --push)
      - name: Build Docker Image (mlflow models build-docker)
        run: |
          # 3. Jalankan 'mlflow models build-docker'
          # (Ini membaca dari 'model_local_output' yang baru dibuat)
          echo "--- (Mulai Kriteria 3 Advance) Mulai Build Docker Image ---"
          mlflow models build-docker \
            --name "tarismajohn/modelling-dicoding-sml-reksi:latest" \
            -m "model_local_output" 
            # (Flag --push dihapus untuk memperbaiki error 'No such option')

      # Langkah 10 (BARU): Push Docker Image (Manual)
      - name: Push Docker Image to Docker Hub
        run: |
          echo "--- Mendorong Image ke Docker Hub ---"
          docker push "tarismajohn/modelling-dicoding-sml-reksi:latest"
            
      # --- PERBAIKAN SELESAI ---