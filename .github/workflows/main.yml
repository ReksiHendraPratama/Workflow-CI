name: Kriteria 3 (Advance) - CI & Build Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-train-and-push:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        shell: bash -l {0} 

    steps:
      # Langkah 1: Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # Langkah 2: Setup Python
      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      # Langkah 3: Setup Conda
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: 3.9
          activate-environment: none 
          auto-activate-base: false

      # Langkah 4 (DIPERBARUI): Install MLflow[docker], DagsHub, dan Joblib
      # (joblib diperlukan oleh mlflow.sklearn.save_model)
      - name: Install MLflow[docker] dependencies in base
        run: |
          pip install "mlflow[docker]" dagshub joblib

      # Langkah 5: Login ke Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # Langkah 6: Setup Kredensial DagsHub
      - name: Set DagsHub Environment Variables
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
        run: |
          echo "MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_USERNAME=${MLFLOW_TRACKING_USERNAME}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_PASSWORD=${MLFLOW_TRACKING_PASSWORD}" >> $GITHUB_ENV

      # Langkah 7: Buat Env Conda secara Manual
      - name: Create Conda Environment from conda.yaml
        run: |
          # Kita juga harus menambahkan joblib ke conda.yaml
          echo "  - joblib" >> MLProject/conda.yaml
          conda env create -f MLProject/conda.yaml

      # --- PERBAIKAN FINAL DI SINI ---
      # Langkah 8 (GABUNGAN): Jalankan Training DAN Build Docker
      - name: Run Training and Build Docker Image
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ env.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ env.MLFLOW_TRACKING_PASSWORD }}
        run: |
          # 1. Aktifkan environment yang baru dibuat
          conda activate mlops-k3-env
          
          # 2. Jalankan script python Anda (Training)
          echo "--- (Mulai Kriteria 3 Basic) Mulai Pelatihan Model ---"
          # (Script ini sekarang akan membuat folder 'model_local_output')
          python MLProject/modelling.py
          
          # 3. Jalankan 'mlflow models build-docker' (Perintah BARU)
          # (Ini akan membaca dari folder 'model_local_output' yang baru dibuat)
          echo "--- (Mulai Kriteria 3 Advance) Mulai Build Docker Image ---"
          mlflow models build-docker \
            --name "tarismajohn/modelling-dicoding-sml-reksi:latest" \
            --push \
            -m "model_local_output" 
            
      # --- PERBAIKAN SELESAI ---